# R - les bases {#rbasics}

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "basics_header_close.png"))
```

Bienvenue !

Cette page passe en revue les éléments essentiels de R. Elle n'a pas pour but d'être un tutoriel complet, mais elle fournit les bases et peut être utile pour rafraîchir votre mémoire. La section [Ressources pour l'apprentissage](#learning) renvoie à des didacticiels plus complets.

Certaines parties de cette page ont été adaptées avec l'autorisation du [projet R4Epis](https://r4epis.netlify.app/).

Voir la page \[Transition vers R\] pour des conseils sur le passage de STATA, SAS ou Excel à R.

```{r, echo=F}
# Importer la liste linéaire nettoyée d'ebola:
linelist <- rio::import(here::here("data", 
                                   "case_linelists", 
                                   "linelist_cleaned.rds"))

# Chargez le paquet apyramid (contient tableaux de données d'exemple):
pacman::p_load(apyramid)
```

<!-- ======================================================= -->

## Pourquoi utiliser R ?

Comme indiqué sur le [site Web du projet R](https://www.r-project.org/about.html), R est un langage de programmation et un environnement pour le calcul statistique et les graphiques. Il est très polyvalent, extensible et axé sur la communauté.

**Coût**

L'utilisation de R est gratuite ! Il existe une forte éthique dans la communauté du matériel gratuit et open-source.

**Reproductibilité**

La gestion et l'analyse de vos données par le biais d'un langage de programmation (par rapport à Excel ou à un autre outil essentiellement manuel) améliore la reproductibilité, facilite la détection des erreurs et allège votre charge de travail.

**Communauté**

La communauté des utilisateurs de R est énorme et collaborative. De nouveaux paquets et outils destinés à résoudre des problèmes concrets sont développés quotidiennement et approuvés par la communauté des utilisateurs. À titre d'exemple, [R-Ladies](https://rladies.org/) est une organisation mondiale dont la mission est de promouvoir la diversité des genres dans la communauté R, et c'est l'une des plus grandes organisations d'utilisateurs de R. Elle a probablement un chapitre près de chez vous !


## Termes clés

**RStudio** - RStudio est une interface utilisateur graphique (GUI) qui facilite l'utilisation de **R**. Pour en savoir plus, consultez la section [RStudio](#rstudio).

**Objets** - Tout ce que vous stockez dans R - les jeu de données, les variables, une liste de noms de villages, un population total d'habitants, et même les résultats tels que les graphiques - sont des *objets* auxquels on *attribue un nom* et qui *peuvent être référencés* dans des commandes ultérieures. Pour en savoir plus, consultez la section [Objets](#objects).

**Fonctions** - Une fonction est une opération de code qui accepte des entrées et renvoie une sortie transformée. Pour en savoir plus, consultez la section [Fonctions](#functions).

**Paquets** - Un paquet R est un ensemble de fonctions partageables. Pour en savoir plus, consultez la section [Packages](#packages).

**Scripts** - Un script est le fichier document qui contient vos commandes. Pour en savoir plus, consultez la section [Scripts](#scripts)


## Ressources pour l'apprentissage {#learning}

### Ressources au sein de RStudio {.unnumbered}

**Documentation d'aide**

Recherchez dans l'onglet "Aide" de RStudio la documentation sur les paquets R et les fonctions spécifiques. Cet onglet se trouve dans le volet qui contient également les fichiers, les graphiques et les paquets (généralement dans le volet inférieur à droit). Comme raccourci, vous pouvez également taper le nom d'un paquet ou d'une fonction dans la console R après un point d'interrogation pour ouvrir la page d'aide correspondante. N'incluez pas les parenthèses.

Par exemple : `?filter` ou `?diagrammeR`.

**Tutoriels interactifs**

Il existe plusieurs façons d'apprendre R de manière interactive *dans* RStudio.

RStudio lui-même offre un volet Tutoriel qui est alimenté par le paquet R [**learnr**](https://blog.rstudio.com/2020/02/25/rstudio-1-3-integrated-tutorials/). Il suffit d'installer ce paquet et d'ouvrir un tutoriel via le nouvel onglet "Tutorial" dans le volet supérieur droit de RStudio (qui contient également les onglets Environnement et Historique).

Le paquet R [**swirl**](https://swirlstats.com/) propose des cours interactifs dans la console R. Installez et chargez ce paquet, puis lancez la commande `swirl()` (parenthèses vides) dans la console R. Vous verrez apparaître des invites dans la console. Répondez en tapant dans la console. Elle vous guidera à travers un cours de votre choix.


### Fiches d'aide-mémoire {.unnumbered}

Il existe de nombreuses fiches d'aide-mémoire au format PDF disponibles sur le [site Web de RStudio](https://rstudio.com/resources/cheatsheets/), par exemple :

-   Facteurs avec le paquet **forcats**\
-   Dates et heures avec le paquet **lubridate**\
-   Chaînes de caractères avec le paquet **stringr**\
-   Opérations itératives avec le paquet **purrr**\
-   Importation de données\
-   Aide-mémoire pour la transformation des données avec le paquet **dplyr**\
-   R Markdown (pour créer des documents comme PDF, Word, Powerpoint...)\
-   Shiny (pour créer des applications Web interactives)\
-   Visualisation de données avec le paquet **ggplot2**\
-   Cartographie (SIG)\
-   Paquet **leaflet** (cartes interactives)\
-   Python avec R (paquet **reticulate**)

Il existe également une ressource R en ligne spécialement destinée aux [utilisateurs d'Excel](https://jules32.github.io/r-for-excel-users/).


### Twitter {.unnumbered}

R possède une communauté Twitter dynamique où vous pouvez apprendre des astuces, des raccourcis et des nouvelles - suivez ces comptes :

-   Suivez-nous ! [\@epiRhandbook](https://twitter.com/epirhandbook)\
-   R Function A Day [\@rfuntionaday](https://twitter.com/rfunctionaday) est une ressource *incroyable*\
-   R pour la science des données [\@rstats4ds](https://twitter.com/rstats4ds?lang=en)\
-   RStudio [\@RStudio](https://twitter.com/rstudio?lang=en)\
-   Conseils sur RStudio [\@rstudiotips](https://twitter.com/rstudiotips)\
-   R-Bloggers [\@Rbloggers](https://twitter.com/Rbloggers)\
-   R-ladies [\@RLadiesGlobal](https://twitter.com/RLadiesGlobal)\
-   Hadley Wickham [\@hadleywickham](https://twitter.com/hadleywickham?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor)

Aussi :

**#epitwitter** et **#rstats**


### Ressources gratuites en ligne {.unnumbered}

Un texte définitif est le livre [R for Data Science](https://r4ds.had.co.nz/) de Garrett Grolemund et Hadley Wickham.

Le site Web du projet [R4Epis](https://r4epis.netlify.app/) vise à "développer des outils standardisés de nettoyage, d'analyse et de rapport des données pour couvrir les types courants d'épidémies et d'enquêtes auprès de la population qui seraient menées dans le cadre d'une réponse d'urgence de MSF". Vous y trouverez des supports de formation aux bases de R, des modèles de rapports RMarkdown sur les épidémies et les enquêtes, ainsi que des tutoriels pour vous aider à les configurer.


### Langues autres que l'anglais {.unnumbered}

[Materiales de RStudio en Español](https://www.rstudio.com/collections/espanol/)

[Introduction à R et au tidyverse (Francais)](https://juba.github.io/tidyverse/index.html)


<!-- ======================================================= -->

## Installation

### R et RStudio {.unnumbered}

**Comment installer R**

Visitez ce site Web <https://www.r-project.org/> et téléchargez la dernière version de R adaptée à votre ordinateur.

**Comment installer RStudio**

Visitez ce site Web <https://rstudio.com/products/rstudio/download/> et téléchargez la dernière version de bureau gratuite de RStudio adaptée à votre ordinateur.

**Autorisations requises**\

Notez que vous devez installer R et RStudio sur un lecteur sur lequel vous avez des droits de lecture et d'écriture. Sinon, votre capacité à installer des paquets R (ce qui arrive fréquemment) sera affectée. Si vous rencontrez des problèmes, essayez d'ouvrir RStudio en faisant un clic droit sur l'icône et en sélectionnant "Exécuter en tant qu'administrateur". Vous trouverez d'autres conseils sur la page \[R sur les lecteurs réseau\].

**Comment mettre à jour R et RStudio**

Votre version de R est imprimée dans la Console R au démarrage. Vous pouvez également exécuter `sessionInfo()`.

Pour mettre à jour R, allez sur le site web mentionné ci-dessus et réinstallez R. Alternativement, vous pouvez utiliser le paquet **installr** (sous Windows) en exécutant `installr::updateR()`. Cela ouvrira des boîtes de dialogue pour vous aider à télécharger la dernière version de R et à mettre à jour vos paquets vers la nouvelle version de R. Plus de détails peuvent être trouvés dans la [documentation de **installr**](https://www.r-project.org/nosvn/pandoc/installr.html).

Sachez que l'ancienne version de R existera toujours sur votre ordinateur. Vous pouvez temporairement exécuter une ancienne version (ancienne "installation") de R en cliquant sur "Outils" -> "Options globales" dans RStudio et en choisissant une version de R. Cela peut être utile si vous voulez utiliser un paquet qui n'a pas été mis à jour pour fonctionner sur la version la plus récente de R.

Pour mettre à jour RStudio, vous pouvez aller sur le site Web ci-dessus et retélécharger RStudio. Une autre option consiste à cliquer sur "Aide" -> "Vérifier les mises à jour" dans RStudio, mais cela peut ne pas montrer les toutes dernières mises à jour.

Pour savoir quelles versions de R, RStudio ou des paquets ont été utilisées lors de la réalisation de ce manuel, consultez la page sur \[Notes éditoriales et techniques\].


### Autres logiciels que vous *pourriez* avoir besoin d'installer {.unnumbered}

-   TinyTeX (*pour la compilation d'un document RMarkdown au format PDF*)\
-   Pandoc (*pour compiler des documents RMarkdown*)\
-   RTools (*pour construire des paquets pour R*)\
-   phantomjs (*pour enregistrer des images fixes de réseaux animés, tels que des chaînes de transmission*)


#### TinyTex {.unnumbered}

TinyTex est une distribution LaTeX personnalisée, utile lorsqu'on essaie de produire des PDF à partir de R.\
Voir <https://yihui.org/tinytex/> pour plus d'informations.

Pour installer TinyTex à partir de R :

```{r, eval=F}

install.packages('tinytex')
tinytex::install_tinytex()

# pour désinstaller TinyTeX, lancez tinytex::uninstall_tinytex()
```

#### Pandoc {.unnumbered}

Pandoc est un convertisseur de document, un logiciel séparé de R. **Il est fourni avec RStudio et ne devrait pas avoir besoin d'être téléchargé.** Il aide le processus de conversion de documents Rmarkdown à des formats comme .pdf et ajoute des fonctionnalités complexes.

#### RTools {.unnumbered}

RTools est une collection de logiciels permettant de construire des paquets pour R.

Installer à partir de ce site web : <https://cran.r-project.org/bin/windows/Rtools/>

#### phantomjs {.unnumbered}

Cet outil est souvent utilisé pour faire des "captures d'écran" des pages web. Par exemple, lorsque vous faites une chaîne de transmission avec le paquet **epicontacts**, un fichier HTML interactif et dynamique est produit. Si vous voulez une image statique, il peut être utile d'utiliser le paquet [**webshot**](https://wch.github.io/webshot/articles/intro.html) pour automatiser ce processus. Cela nécessite le programme externe "phantomjs". Vous pouvez installer phantomjs via le paquet **webshot** avec la commande `webshot::install_phantomjs()`.


<!-- ======================================================= -->

### RStudio {#rstudio}

### Orientation de RStudio {.unnumbered}

**D'abord, ouvrez RStudio.** Comme leurs icônes peuvent être très similaires, assurez-vous que vous ouvrez bien *RStudio* et non pas R.

Pour que RStudio fonctionne, vous devez également avoir R installé sur l'ordinateur (voir ci-dessus pour les instructions d'installation).

**RStudio** est une interface (GUI) pour une utilisation plus facile de **R**. Vous pouvez considérer R comme le moteur d'un véhicule, qui effectue le travail crucial, et RStudio comme le corps du véhicule (avec les sièges, les accessoires, etc.) qui vous aide à utiliser le moteur pour avancer ! Vous pouvez consulter la fiche technique complète de l'interface utilisateur de RStudio (PDF) [ici](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf)

Par défaut, RStudio affiche quatre volets rectangulaires.

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "RStudio_overview.png"))
```

[***TIP:*** Si votre RStudio n'affiche qu'un seul volet gauche, c'est parce que vous n'avez pas encore de scripts ouverts.]{style="color: black;"}

**Le volet source**

Ce volet, par défaut en haut à gauche, est un espace pour éditer, exécuter et enregistrer vos [scripts](#scripts). Les scripts contiennent les commandes que vous souhaitez exécuter. Ce volet peut également afficher des ensembles de données (cadres de données) pour les visualiser.

Pour les utilisateurs de Stata, ce volet est similaire aux fenêtres Do-file et Data Editor.

**Le volet Console R**

La console R, qui est par défaut le volet gauche ou inférieur gauche de R Studio, est le siège du "moteur" R. C'est là que les commandes sont réellement exécutées et que les sorties non graphiques et les messages d'erreur/d'avertissement apparaissent. Vous pouvez saisir et exécuter directement des commandes dans la console R, mais sachez que ces commandes ne sont pas enregistrées comme c'est le cas lorsque vous exécutez des commandes à partir d'un script.

Si vous êtes familier avec Stata, la console R ressemble à la fenêtre de commande et à la fenêtre des résultats.

**Le volet Environnement**

Ce volet, situé par défaut en haut à droite, est le plus souvent utilisé pour afficher de brefs résumés des [objets](#objets) de l'environnement R dans la session en cours. Ces objets peuvent inclure des ensembles de données importés, modifiés ou créés, des paramètres que vous avez définis (par exemple, une semaine épi spécifique pour l'analyse), ou des vecteurs ou des listes que vous avez définis pendant l'analyse (par exemple, les noms des régions). Vous pouvez cliquer sur la flèche à côté du nom d'un cadre de données pour voir ses variables.

Dans Stata, cette fenêtre est très similaire à celle du gestionnaire de variables.

Ce volet contient également l'onglet "Historique" où vous pouvez voir les commandes que vous avez exécutées précédemment.  Il comporte également un onglet "Tutoriel" où vous pouvez suivre des tutoriels R interactifs si vous avez installé le paquet **learnr**. En outre, il existe un volet "Connexions" pour les connexions aux bases de données externes.  Si vous avez lié le répertoire actif à un dépôt sur Github, il y aura également un volet "Git".


**Volets Graphiques, visionneuse, paquets et aide**

Le volet inférieur droit comprend plusieurs onglets importants. Les graphiques de tracé typiques, y compris les cartes, s'affichent dans le volet Tracé. Les sorties interactives ou HTML s'affichent dans le volet Visionneuse. Le volet Aide permet d'afficher la documentation et les fichiers d'aide. Le volet Fichiers est un navigateur qui peut être utilisé pour ouvrir ou supprimer des fichiers. Le volet Paquets vous permet de voir, d'installer, de mettre à jour, de supprimer, de charger/décharger des paquets R et de voir quelle version du paquet vous avez. Pour en savoir plus sur les paquets, consultez la [section paquets](#packages) ci-dessous.

Ce volet contient les équivalents Stata des fenêtres Plots Manager et Project Manager.


### Paramètres RStudio {.unnumbered}

Modifiez les paramètres et l'apparence de RStudio dans le menu déroulant *Outiles*, en sélectionnant *Options globales*. Vous pouvez y modifier les paramètres par défaut, y compris l'apparence/couleur de fond.


```{r out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "RStudio_tools_options_1.png"))

knitr::include_graphics(here::here("images", "RStudio_tools_options.png"))
```

**Redémarrage**
 
Si votre R se fige, vous pouvez redémarrer R en allant dans le menu Session et en cliquant sur "Redémarrer R". Cela vous évite de devoir fermer et ouvrir RStudio. Tout ce qui se trouve dans votre environnement R sera supprimé lorsque vous ferez cela.

### Raccourcis clavier {.unnumbered}

Vous trouverez ci-dessous quelques raccourcis clavier très utiles. Vous trouverez tous les raccourcis clavier pour Windows, Max et Linux sur la deuxième page de ce [fichier technique](https://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf) par RStudio.


+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Windows/Linux                    | Mac                    | Action                                                                                                                         |
+==================================+========================+================================================================================================================================+
| Esc                              | Esc                    | Interrompre la commande en cours (utile si vous avez accidentellement lancé une commande incomplète et que vous ne pouvez pas éviter de voir "+" dans la console R) |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl+s                           | Cmd+s                  | Sauvegarder (script)                                                                                                                  |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Tab                              | Tab                    | Autocomplétion                                                                                                                  |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Enter                     | Cmd + Enter            | Exécuter la ou les ligne(s) courante(s)/sélection(s) de code                                                                                          |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + C                 | Cmd + Shift + c        | commenter/dé-commenter les lignes souslignées                                                                                        |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Alt + -                          | Option + -             | Insérer `<-`                                                                                                                    |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + m                 | Cmd + Shift + m        | Insérer `%>%`                                                                                                                   |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + l                         | Cmd + l                | Effacer le contenu de la console R                                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + b                   | Cmd + Option + b       | Exécuter du début à la ligne courante                                                                                                 |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + t                   | Cmd + Option + t       | Exécuter la section de code actuelle (R Markdown)                                                                                      |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + i                   | Cmd + Shift + r        | Insérer un morceau de code (en R Markdown)                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Alt + c                   | Cmd + Option + c       | Exécuter le morceau de code actuel (en R Markdown)                                                                                            |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Flèches haut/bas dans la console R      | Idem                   | Basculer entre les commandes récemment exécutées                                                                                           |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Shift + flèches haut/bas dans le script | Idem                   | Sélectionner plusieurs lignes de code                                                                                                     |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + f                         | Cmd + f                | Rechercher et remplacer dans le script actuel                                                                                             |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Ctrl + Shift + f                 | Cmd + Shift + f        | Rechercher dans les dossiers (rechercher/remplacer dans plusieurs scripts)                                                                             |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Alt + l                          | Cmd + Option + l       | Plier le code sélectionné                                                                                                             |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+
| Shift + Alt + l                  | Cmd + Shift + Option+l | Déplier le code sélectionné                                                                                                           |
+----------------------------------+------------------------+--------------------------------------------------------------------------------------------------------------------------------+

[***TIP:*** Utilisez votre touche de tabulation lorsque vous tapez pour activer la fonctionnalité de complétion automatique de RStudio. Cela peut éviter les fautes d'orthographe. Appuyez sur la touche Tab pendant la saisie pour produire un menu déroulant de fonctions et d'objets probables, en fonction de ce que vous avez tapé jusqu'à présent.]{style="color: darkgreen;"}


<!-- ======================================================= -->

## Fonctions {#functions}

Les fonctions sont au cœur de l'utilisation de R. Les fonctions vous permettent d'effectuer des tâches et des opérations. De nombreuses fonctions sont installées avec R, beaucoup d'autres sont disponibles à télécharger dans des *paquets* (expliqués dans la section [paquets](#packages)), et vous pouvez même écrire vos propres fonctions personnalisées !

Cette section de base sur les fonctions explique :

-   Ce qu'est une fonction et comment elle fonctionne\
-   Ce que sont les *paramètres* des fonctions\
-   Comment obtenir de l'aide pour comprendre une fonction

*Une note rapide sur la syntaxe :* Dans ce manuel, les fonctions sont écrites en code-texte avec des parenthèses vides, comme ceci : `filter()`. Comme expliqué dans la section [paquets](#packages), les fonctions sont téléchargées dans des *paquets*. Dans ce manuel, les noms de paquets sont écrits en **gras**, comme **dplyr**. Parfois, dans le code d'exemple, vous pouvez voir le nom de la fonction lié explicitement au nom de son paquet avec deux points de suspension (`::`) comme ceci : `dplyr::filter()`. Le but de ce lien est expliqué dans la section sur les paquets.

<!-- ======================================================= -->

### Fonctions simples {.unnumbered}

**Une fonction est comme une machine qui reçoit des entrées, effectue une action avec ces entrées, et produit une sortie.** La nature de la sortie dépend de la fonction.

**Les fonctions opèrent généralement sur un objet placé entre les parenthèses de la fonction**. Par exemple, la fonction `sqrt()` calcule la racine carrée d'un nombre :

```{r basics_function_sqrt}
sqrt(49)
```

L'objet fourni à une fonction peut également être une colonne dans un jeu de données (voir la section [Objets](#objects) pour plus de détails sur tous les types d'objets). Comme R peut stocker plusieurs jeux de données, vous devrez spécifier à la fois le jeu de données et la colonne. Une façon de le faire est d'utiliser la notation `$` pour lier le nom du jeu de données et le nom de la colonne (`dataset$column`). Dans l'exemple ci-dessous, la fonction `summary()` est appliquée à la colonne numérique `age` du jeu de données `linelist`, et la sortie est un résumé des valeurs numériques et manquantes de la colonne.

```{r basics_functions_summary}
# Imprimez les statistiques sommaires de la colonne 'age' dans le jeu de données 'linelist'.
summary(linelist$age)
```

[***NOTE:*** En coulisses, une fonction représente un code supplémentaire complexe qui a été regroupé pour l'utilisateur dans une seule commande simple.]{style="color: black;"}

<!-- ======================================================= -->

### Fonctions à paramètres multiples {.unnumbered}

Les fonctions demandent souvent plusieurs entrées, appelées ***paramètres***, situées entre les parenthèses de la fonction, généralement séparées par des virgules.

-   Certains paramètres sont obligatoires pour que la fonction fonctionne correctement, d'autres sont facultatifs\
-   Les paramètres facultatifs ont des valeurs par défaut\
-   Les paramètres peuvent prendre des entrées de type caractère, numérique, logique (VRAI/FAUX) et autres.


Voici une fonction fictive amusante, appelée `oven_bake()` (cuisson au four), comme exemple d'une fonction typique. Elle prend un objet comme entrée (par exemple un jeu de données, ou dans cet exemple "pâte") et effectue des opérations sur celui-ci comme spécifié par des paramètres supplémentaires (`minutes =` et `température =`).  La sortie peut être imprimée sur la console, ou sauvegardée comme un objet en utilisant l'opérateur d'affectation `<-`.

```{r basics_functions_image, echo=F, out.width = "75%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Function_Bread_Example.png"))
```

**Dans un exemple plus réaliste**, la commande `age_pyramid()` ci-dessous produit un graphique de pyramide des âges basé sur des groupes d'âge définis et une colonne de division binaire, comme le genre `gender`. La fonction reçoit trois paramètres entre parenthèses, séparés par des virgules. Les valeurs fournies aux paramètres établissent `linelist` comme le cadre de données à utiliser, `age_cat5` comme la colonne à compter, et `gender` comme la colonne binaire à utiliser pour diviser la pyramide par couleur.

```{r basics_functions_arguments, include=FALSE, results='hide', message=FALSE, warning=FALSE,}
## Créer une variable de groupe d'âge en spécifiant des ruptures catégorielles
linelist$age_group <- cut(linelist$age, breaks = c(0, 5, 10, 15, 20, 30, 45, 60))
```

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Créer une pyramide des âges
age_pyramid(data = linelist, age_group = "age_cat5", split_by = "gender")
```

La commande ci-dessus peut être écrite de manière équivalente comme ci-dessous, dans un style plus long avec une nouvelle ligne pour chaque argument. Ce style peut être plus facile à lire, et plus facile d'écrire des "commentaires" avec `#` pour expliquer chaque partie (commenter abondamment est une bonne pratique !). Pour exécuter cette commande plus longue, vous pouvez souligner la commande entière et cliquer sur "Run", ou simplement placer votre curseur sur la première ligne et appuyer simultanément sur les touches `Ctrl` et `Enter`.

```{r message=FALSE, warning=FALSE,  out.width = "75%", out.height="75%"}
# Créer une pyramide des âges
age_pyramid(
  data = linelist,        # utiliser la liste linéaire des cas
  age_group = "age_cat5", # fournir une colonne de groupe d'âge
  split_by = "gender"     # utiliser la colonne genre pour les deux côtés de la pyramide
  )
```

La première moitié d'une affectation de paramètre (par exemple `data =`) n'a pas besoin d'être spécifiée si les paramètres sont écrits dans un ordre spécifique (spécifié dans la documentation de la fonction). Le code ci-dessous produit exactement la même pyramide que ci-dessus, parce que la fonction attend l'ordre des paramètres : cadre de données, le variable `age_group`, puis le variable `split_by`.

```{r, basics_functions_pyramid2, eval = FALSE, warning=FALSE, message=FALSE, , out.width = "75%", out.height="75%", eval=F}
# Cette commande produira exactement le même graphique que ci-dessus
age_pyramid(linelist, "age_cat5", "gender")
```

**Une commande `age_pyramid()` plus complexe pourrait inclure les paramètres *optionnels* pour :**

-   Afficher les proportions au lieu des nombres (définissez `proportional = TRUE` (vrai) quand la valeur par défaut est `FALSE` (faux))`\
-   Spécifier les deux couleurs à utiliser (`pal =` est l'abréviation de "palette" et est fourni avec un vecteur de deux noms de couleurs. Voir la page [objets](#objectstructure) pour savoir comment la fonction `c()` fabrique un vecteur).

[***NOTE:*** Pour les paramètres que vous spécifiez avec les deux parties du paramètre (par exemple `proportional = TRUE`), leur ordre parmi tous les paramètres n'a pas d'importance.]{style="color: black;"}

```{r message=FALSE, warning=FALSE, out.width = "75%", out.height="75%"}
age_pyramid(
  linelist,                    # utiliser la liste linéaire des cas
  "age_cat5",                  # colonne de groupe d'âge
  "gender",                    # répartition par genre
  proportional = TRUE,         # pourcentage au lieu du nombre
  pal = c("orange", "purple")  # couleurs
  )
```

<!-- ======================================================= -->

### Ecrire des fonctions {.unnumbered}

R est un langage orienté autour des fonctions, vous devez donc vous sentir capable d'écrire vos propres fonctions. La création de fonctions présente plusieurs avantages :

-   Faciliter la programmation modulaire - la séparation du code en morceaux indépendants et gérables\
-   Remplacer le copier-coller répétitif, qui peut être source d'erreurs\
-   Donner des noms mémorisables aux morceaux de code

L'écriture d'une fonction est traitée en détail à la page [Écriture de fonctions].

<!-- ======================================================= -->

## Paquets {#packages}

**Les paquets contiennent des fonctions.**

Un paquet en R est un ensemble partageable de code et de documentation qui contient des fonctions prédéfinies. Les utilisateurs de la communauté R développent en permanence des packages répondant à des problèmes spécifiques; donc il est probable que l'un d'entre eux puisse vous aider dans votre travail ! Vous allez installer et utiliser des centaines de paquets dans votre utilisation de R.

À l'installation, R contient des paquets et des fonctions **"de base "** qui effectuent des tâches élémentaires communes. Mais de nombreux utilisateurs de R créent des fonctions spécialisées, qui sont vérifiées par la communauté R et que vous pouvez télécharger en tant que **paquet** pour votre propre usage. Dans ce manuel, les noms des paquets sont écrits en **gras**. L'un des aspects les plus difficiles de R est qu'il existe souvent de nombreuses fonctions ou paquets parmi lesquels on peut choisir pour effectuer une tâche donnée.


### Installer et charger {.unnumbered}

Les *fonctions* sont contenues dans des **paquets** qui peuvent être téléchargés ("installés") sur votre ordinateur à partir d'Internet. Une fois qu'un paquet est téléchargé, il est stocké dans votre "bibliothèque". Vous pouvez alors accéder aux fonctions qu'il contient pendant votre séance R actuelle en "chargeant" le paquet.

*Pensez à R comme votre bibliothèque personnelle* : Lorsque vous téléchargez un paquet, votre bibliothèque gagne un nouveau livre de fonctions, mais chaque fois que vous voulez utiliser une fonction de ce livre, vous devez emprunter ("charger") ce livre dans votre bibliothèque.

En résumé : pour utiliser les fonctions disponibles dans un paquet R, deux étapes doivent être mises en œuvre :

1)  Le paquet doit être **installé** (une fois), *et*\
2)  Le paquet doit être **chargé** (à chaque séance R)


#### Votre bibliothèque {.unnumbered}

Votre "bibliothèque" est en fait un dossier sur votre ordinateur, contenant un dossier pour chaque paquet qui a été installé. Déterminez où R est installé sur votre ordinateur, et cherchez un dossier appelé "win-library". Par exemple : `R\win-library\4.0` (4.0 est la version de R). Notez que vous aurez une bibliothèque différente pour chaque version de R que vous avez téléchargée.

Vous pouvez imprimer le chemin d'accès à votre bibliothèque en entrant `.libPaths()` (parenthèses vides).Ceci devient particulièrement important si vous travaillez avec \[R sur des lecteurs réseau\].


#### Installer à partir du CRAN {.unnumbered}

Le plus souvent, les utilisateurs de R téléchargent des paquets depuis CRAN. CRAN (Comprehensive R Archive Network) est un entrepôt public en ligne de paquets R qui ont été publiés par des membres de la communauté R.

Vous vous inquiétez des virus et de la sécurité lorsque vous téléchargez un paquet depuis CRAN ? Lisez [cet article](https://support.rstudio.com/hc/en-us/articles/360042593974-R-and-R-Package-Security) à ce sujet.

#### Comment installer et charger {.unnumbered}

Dans ce manuel, nous suggérons d'utiliser le paquet **pacman** (abréviation de "package manager" en anglais). Il offre une fonction pratique `p_load()` qui installera un paquet si nécessaire *et* le chargera pour l'utiliser dans la séance R actuelle.

La syntaxe est assez simple. Il suffit de lister les noms des paquets entre les parenthèses de `p_load()`, séparés par des virgules. 

La commande ci-dessous installera les paquets **rio**, **tidyverse**, et **here** s'ils ne sont pas encore installés, et les chargera pour les utiliser. Cela rend l'approche `p_load()` pratique et concise si vous partagez des scripts avec d'autres personnes. Notez que les noms des paquets sont sensibles à la casse.


```{r}
# Installer (si nécessaire) et charger les paquets pour l'utilisation
pacman::p_load(rio, tidyverse, here)
```

Notez que nous avons utilisé la syntaxe `pacman::p_load()` qui écrit explicitement le nom du paquet (**pacman**) avant le nom de la fonction (`p_load()`), reliés par deux deux points `::`. Cette syntaxe est utile car elle charge également le paquet **pacman** (en supposant qu'il soit déjà installé).

Il existe d'autres fonctions R **de base** que vous verrez souvent. La fonction R **de base** pour installer un paquet est `install.packages()`. Le nom du paquet à installer doit être fourni entre les parenthèses et *entre guillemets*. Si vous voulez installer plusieurs paquets en une seule commande, ils doivent être listés dans un vecteur de caractères `c()`.

Remarque : cette commande *installe* un paquet, mais ne le charge *pas* pour l'utiliser dans la séance en cours.

```{r, eval=F}
# Installer un seul paquet avec la base R
install.packages("tidyverse")

# Installer plusieurs paquets avec la base R
install.packages(c("tidyverse", "rio", "here"))
```

L'installation peut également être effectuée par pointer-cliquer en allant dans le panneau "Packages" de RStudio, en cliquant sur "Installer" et en recherchant le nom du paquet souhaité.

La fonction **base** de R pour **charger** un paquet à utiliser (après qu'il ait été installé) est `library()`. Elle ne peut charger qu'un seul paquet à la fois (une autre raison d'utiliser `p_load()`). Vous pouvez fournir le nom du paquet avec ou sans guillemets.

```{r, eval=F}
# Charger des paquets à utiliser, avec la base R
library(tidyverse)
library(rio)
library(here)
```

Pour vérifier si un paquet est installé et/ou chargé, vous pouvez afficher le panneau des paquets dans RStudio. Si le paquet est installé, il est affiché avec son numéro de version. Si sa case est cochée, il est chargé pour la séance en cours.

**Installation depuis Github**

Parfois, vous avez besoin d'installer un paquet qui n'est pas encore disponible sur CRAN. Ou peut-être que le paquet est disponible sur CRAN mais que vous voulez la *version de développement* avec de nouvelles fonctionnalités qui ne sont pas encore proposées dans la version CRAN publiée, plus stable. Ces versions sont souvent hébergées sur le site Web [github.com](https://github.com/) dans un "dépôt" de code libre et public. Pour en savoir plus sur Github, consultez la page du manuel intitulée \[Contrôle de version et collaboration avec Git et Github\].

Pour télécharger des paquets R depuis Github, vous pouvez utiliser la fonction `p_load_gh()` de **pacman**, qui installera le paquet si nécessaire, et le chargera pour l'utiliser dans votre séance R actuelle. Les alternatives à l'installation incluent l'utilisation des paquets **remotes** ou **devtools**. Pour en savoir plus sur toutes les fonctions de **pacman**, consultez la [documentation du paquet](https://cran.r-project.org/web/packages/pacman/pacman.pdf).

Pour installer à partir de Github, vous devez fournir plus d'informations. Vous devez fournir :

1)  L'ID Github (nom d'utilisateur) du propriétaire du dépôt.
2)  Le nom du dépôt qui contient le paquet.
3)  *(facultatif) Le nom de la "branche" (version de développement spécifique) que vous souhaitez télécharger*.

Dans les exemples ci-dessous, le premier mot entre guillemets est l'ID Github du propriétaire du dépôt. Après la barre oblique est le nom du dépôt (typiquement le nom du paquet).


```{r, eval=F}
# Installer/charger le paquet epicontacts depuis son dépôt Github
p_load_gh("reconhub/epicontacts")
```

Si vous voulez installer à partir d'une "branche" (version) autre que la branche principale, ajoutez le nom de la branche après un "\@", après le nom du dépôt.

```{r, eval=F}
# Installer la branche "timeline" du paquet epicontacts depuis Github
p_load_gh("reconhub/epicontacts@timeline")
```

S'il n'y a pas de différence entre la version Github et la version sur votre ordinateur, aucune action ne sera entreprise. Vous pouvez "forcer" une réinstallation en utilisant `p_load_current_gh()` avec le paramètre `update = TRUE`. Lisez plus sur **pacman** dans cette [vignette en ligne](http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html)

**Installation à partir d'un ZIP ou d'un TAR**

Vous pouvez installer le paquet à partir d'une URL :

```{r, eval=F}
packageurl <- "https://cran.r-project.org/src/contrib/Archive/dsr/dsr_0.2.2.tar.gz"
install.packages(packageurl, repos = NULL, type = "source")
```

Ou bien, le télécharger sur votre ordinateur dans un fichier zippé :

Option 1 : utiliser `install_local()` du paquet **remotes**.

```{r, eval=F}
remotes::install_local("~/Downloads/dplyr-master.zip")
```

Option 2 : en utilisant `install.packages()` du R de **base**, en fournissant le chemin d'accès au fichier ZIP et en définissant `type = "source"` et `repos = NULL`.

```{r, eval=F}
install.packages("~/Downloads/dplyr-master.zip", 
                 type = "source", 
                 repos = NULL)
```

### Syntaxe du code {.unnumbered}

Pour plus de clarté dans ce manuel, les fonctions sont parfois précédées du nom de leur paquet en utilisant le symbole `::` de la manière suivante : `nom_du_paquet::nom_de_la_fonction()`.

Une fois qu'un paquet est chargé pour une séance, ce style explicite n'est plus nécessaire. On peut simplement utiliser `nom_de_la_fonction()`. Cependant, écrire le nom du paquet est utile lorsqu'un nom de fonction est commun et peut exister dans plusieurs paquets (par exemple, `plot()`). L'écriture du nom du paquet chargera également le paquet s'il n'est pas déjà chargé.


```{r eval=FALSE}
# Cette commande utilise le paquet "rio" et sa fonction "import()" pour importer un jeu de données
linelist <- rio::import("linelist.xlsx", which = "Sheet1")
```

### Aide sur les fonctions {.unnumbered}

Pour en savoir plus sur une fonction, vous pouvez la rechercher dans l'onglet Aide du RStudio en bas à droite. Vous pouvez également lancer une commande comme `?thefunctionname` (mettez le nom de la fonction après un point d'interrogation) et la page d'aide apparaîtra dans le volet d'aide. Enfin, essayez de rechercher des ressources en ligne.

### Mettre à jour les paquets {.unnumbered}

Vous pouvez mettre à jour les paquets en les réinstallant. Vous pouvez également cliquer sur le bouton vert "Update" dans votre panneau "RStudio Packages" pour voir quels paquets ont de nouvelles versions à installer. Sachez que votre ancien code peut avoir besoin d'être mis à jour s'il y a une révision majeure du fonctionnement d'une fonction !

### Supprimer des paquets {.unnumbered}

Utilisez `p_delete()` de **pacman**, ou `remove.packages()` de **base** R. Alternativement, allez chercher le dossier qui contient votre bibliothèque et supprimez manuellement le dossier.

### Dépendances {.unnumbered}

Les paquets dépendent souvent d'autres paquets pour fonctionner. Ceux-ci sont appelés dépendances. Si une dépendance ne s'installe pas, le paquet qui en dépend peut également ne pas s'installer.

Voir les dépendances d'un paquet avec `p_depends()`, et voir quels paquets en dépendent avec `p_depends_reverse()`.

### Fonctions masquées {.unnumbered}

Il n'est pas rare que deux paquets ou plus contiennent le même nom de fonction. Par exemple, le paquet **dplyr** possède une fonction `filter()`, mais le paquet **stats** aussi. La fonction `filter()` par défaut dépend de l'ordre dans lequel ces paquets sont chargés pour la première fois dans la séance R - le dernier sera la fonction par défaut de la commande `filter()`.

Vous pouvez vérifier l'ordre dans votre panneau Environnement de R Studio - cliquez sur la liste déroulante pour "Global Environment" et voyez l'ordre des paquets. Les fonctions des paquets *inférieurs* dans cette liste déroulante masqueront les fonctions du même nom dans les paquets qui apparaissent plus haut dans la liste déroulante. Lors du premier chargement d'un paquet, R vous avertira dans la console si le masquage se produit, mais il est facile de ne pas le voir.

```{r out.width = "50%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "masking_functions.png"))
```

Voici comment vous pouvez corriger le masquage :

1)  Spécifiez le nom du paquet dans la commande. Par exemple, utilisez `dplyr::filter()`\
2)  Réorganisez l'ordre dans lequel les paquets sont chargés (par exemple, dans `p_load()`), et **démarrez une nouvelle séance R**.

### Détacher / décharger {.unnumbered}

Pour détacher (décharger) un paquet, utilisez cette commande, avec le nom correct du paquet et un seul deux-points. Notez que cela peut ne pas résoudre le masquage.

```{r, eval=F}
detach(package:NOM_DU_PAQUET_ICI, unload = TRUE)
```

### Installer une ancienne version {.unnumbered}

Consultez ce [guide](https://support.rstudio.com/hc/en-us/articles/219949047-Installing-older-versions-of-packages) pour installer une ancienne version d'un paquet particulier.

### Paquets suggérés {.unnumbered}

Voir la page [Paquets suggérés] pour une liste de paquets que nous recommandons pour l'épidémiologie quotidienne.


<!-- ======================================================= -->

## Scripts {#scripts}

Les scripts sont une partie fondamentale de la programmation. Ce sont des documents qui contiennent vos commandes (par exemple, des fonctions pour créer et modifier des jeux de données, imprimer des visualisations, etc). Vous pouvez sauvegarder un script et l'exécuter à nouveau ultérieurement. Le stockage et l'exécution de vos commandes à partir d'un script présentent de nombreux avantages (par rapport à la saisie des commandes une par une dans la "ligne de commande" de la console R) :

-   Portabilité : vous pouvez partager votre travail avec d'autres personnes en leur envoyant vos scripts\
-   Reproductibilité : pour que vous et les autres sachiez exactement ce que vous avez fait\
-   Contrôle de version : pour que vous puissiez suivre les modifications apportées par vous-même ou par vos collègues\
-   Commentaire/annotation : pour expliquer à vos collègues ce que vous avez fait

### Commentaire {.unnumbered}

Dans un script, vous pouvez également annoter ("commenter") votre code R. Les commentaires sont utiles pour expliquer à vous-même et aux autres lecteurs ce que vous faites. Vous pouvez ajouter un commentaire en tapant le symbole dièse (#) et en écrivant votre commentaire après. Le texte commenté apparaîtra dans une couleur différente de celle du code R.

Tout code écrit après le \# ne sera pas exécuté. Par conséquent, placer un \# avant le code est également un moyen utile de bloquer temporairement une ligne de code ("commenter") si vous ne souhaitez pas la supprimer). Vous pouvez mettre en commentaire plusieurs lignes à la fois en les soulignant et en appuyant sur Ctrl+Shift+c (Cmd+Shift+c sur Mac).

```{r, eval = F}

# Un commentaire peut être sur une ligne par lui-même, ex.:
# Importer des données:
linelist <- import("linelist_raw.xlsx") %>% # un commentaire peut aussi venir après le code
     # filter(age > 50)
     # Il peut aussi être utilisé pour désactiver une ligne de code
count()

```

Vous trouverez ci-dessous quelques conseils essentiels pour commenter et annoter votre code :

-   Commentez *ce que vous faites* et *pourquoi* vous le faites\
-   Découpez votre code en sections logiques\
-   Accompagnez votre code d'une description textuelle étape par étape de ce que vous faites (par exemple, des étapes numérotées).


### Style {.unnumbered}

Il est important d'être conscient de votre style de codage, surtout si vous travaillez en équipe. Nous préconisons le **tidyverse** [guide de style](https://style.tidyverse.org/). Il existe également des paquets tels que **styler** et **lintr** qui vous aident à vous conformer à ce style.

Quelques points très basiques pour rendre votre code lisible pour les autres:\
\* Lorsque vous nommez des objets, n'utilisez que des lettres minuscules, des chiffres et des traits de soulignement `_`, par exemple `mes_donnees`\
\* Utilisez fréquemment des espaces, y compris autour des opérateurs, par exemple `n = 1` et `age_nouveau <- age_vieillesse + 3`.

### Exemple de script {.unnumbered}

Vous trouverez ci-dessous un exemple d'un court script R. N'oubliez pas que plus vous expliquerez succinctement votre code dans les commentaires, plus vos collègues vous apprécieront !

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "example_script.png"))
```

<!-- ======================================================= -->

### R markdown {.unnumbered}

Un script R markdown est un type de script R dans lequel le script lui-même *devient* un document de sortie (PDF, Word, HTML, Powerpoint, etc.). Ce sont des outils incroyablement utiles et polyvalents, souvent utilisés pour créer des rapports dynamiques et automatisés. Même ce site Web et ce manuel sont produits à l'aide de scripts R markdown !

Il convient de noter que les utilisateurs débutants de R peuvent également utiliser R Markdown - ne vous laissez pas intimider !Pour en savoir plus, consultez la page du manuel consacrée aux \[Rapports avec des documents R Markdown\].

<!-- ======================================================= -->

### Carnets de notes R {.unnumbered}

Il n'y a pas de différence entre écrire dans un Rmarkdown et un R notebook. Cependant, l'exécution du document diffère légèrement. Voir ce [site](http://uc-r.github.io/r_notebook) pour plus de détails.

<!-- ======================================================= -->

### Shiny {.unnumbered}

Les applications/sites web Shiny sont contenus dans un script, qui doit être nommé `app.R`. Ce fichier comporte trois éléments :

1)  Une interface utilisateur (ui)\
2)  Une fonction serveur\
3)  Un appel à la fonction `shinyApp`

Consultez la page du manuel sur \[les tableaux de bord avec Shiny\], ou ce tutoriel en ligne :  [Tutoriel Shiny](https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/)

*Auparavant, le fichier ci-dessus était divisé en deux fichiers (`ui.R` et `server.R`)*.

### Repli du code {.unnumbered}

Vous pouvez replier des portions de code pour rendre votre script plus facile à lire.

Pour ce faire, créez un en-tête de texte avec #, écrivez votre en-tête, et faites-le suivre d'au moins 4 tirets (-), hachages (#) ou égaux (=). Lorsque vous aurez fait cela, une petite flèche apparaîtra dans la "gouttière" à gauche (près du numéro de ligne). Vous pouvez cliquer sur cette flèche et sur le code situé en dessous jusqu'à ce que l'en-tête suivant se réduise et qu'une icône à double flèche apparaisse à sa place.

Pour développer le code, cliquez à nouveau sur la flèche dans la gouttière ou sur l'icône à double flèche. Il existe également des raccourcis clavier, comme expliqué dans la section [RStudio](#rstudio) de cette page.

En créant des en-têtes avec #, vous activerez également la table des matières au bas de votre script (voir ci-dessous) que vous pouvez utiliser pour naviguer dans votre script. Vous pouvez créer des sous-titres en ajoutant d'autres symboles, par exemple \# pour les titres primaires, ## pour les titres secondaires et ##\# pour les titres tertiaires.

Vous trouverez ci-dessous deux versions d'un exemple de script. À gauche, l'original avec des en-têtes commentés. À droite, quatre tirets ont été écrits après chaque en-tête, les rendant ainsi repliables. Deux d'entre eux ont été réduits, et vous pouvez voir que la table des matières en bas de page affiche maintenant chaque section.

```{r, out.width = c('50%'), fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "code_folding1.png"))
knitr::include_graphics(here::here("images", "code_folding2.png"))
```

D'autres zones de code qui sont automatiquement éligibles pour le pliage incluent les régions "accolées" avec des parenthèses `{ }` telles que les définitions de fonctions ou les blocs conditionnels (instructions "if else"). Vous pouvez en savoir plus sur le pliage du code sur le [site RStudio](https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections).


<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Working directory

The working directory is the root folder location used by R for your work - where R looks for and saves files by default. By default, it will save new files and outputs to this location, and will look for files to import (e.g. datasets) here as well.

The working directory appears in grey text at the top of the RStudio Console pane. You can also print the current working directory by running `getwd()` (leave the parentheses empty).

```{r out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "working_directory_1.png"))
```

### Recommended approach {.unnumbered}

**See the page on \[R projects\] for details on our recommended approach to managing your working directory.**\
A common, efficient, and trouble-free way to manage your working directory and file paths is to combine these 3 elements in an \[R project\]\[R projects\]-oriented workflow:

1)  An R Project to store all your files (see page on \[R projects\])\
2)  The **here** package to locate files (see page on \[Import and export\])\
3)  The **rio** package to import/export files (see page on \[Import and export\])

<!-- ======================================================= -->

### Set by command {.unnumbered}

Until recently, many people learning R were taught to begin their scripts with a `setwd()` command. Please instead consider using an \[R project\]\[R projects\]-oriented workflow and read the [reasons for not using `setwd()`](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/). In brief, your work becomes specific to your computer, file paths used to import and export files become "brittle", and this severely hinders collaboration and use of your code on any other computer. There are easy alternatives!

As noted above, although we do not recommend this approach in most circumstances, you can use the command `setwd()` with the desired folder file path in quotations, for example:

```{r, eval=F}
setwd("C:/Documents/R Files/My analysis")
```

[***DANGER:*** Setting a working directory with `setwd()` *can* be "brittle" if the file path is specific to one computer. Instead, use file paths relative to an R Project root directory (with the **here** package). ]{style="color: red;"}

<!-- ======================================================= -->

### Set manually {.unnumbered}

To set the working directory manually (the point-and-click equivalent of `setwd()`), click the Session drop-down menu and go to "Set Working Directory" and then "Choose Directory". This will set the working directory for that specific R session. Note: if using this approach, you will have to do this manually each time you open RStudio.

<!-- ======================================================= -->

### Within an R project {.unnumbered}

If using an R project, the working directory will default to the R project root folder that contains the ".rproj" file. This will apply if you open RStudio by clicking open the R Project (the file with ".rproj" extension).

<!-- ======================================================= -->

### Working directory in an R markdown {.unnumbered}

In an R markdown script, the default working directory is the folder the Rmarkdown file (`.Rmd`) is saved within. If using an R project and **here** package, this does not apply and the working directory will be `here()` as explained in the \[R projects\] page.

If you want to change the working directory of a stand-alone R markdown (not in an R project), if you use `setwd()` this will only apply to that specific code chunk. To make the change for all code chunks in an R markdown, edit the setup chunk to add the `root.dir =` parameter, such as below:

```{r, eval=F}
knitr::opts_knit$set(root.dir = 'desired/directorypath')
```

It is much easier to just use the R markdown within an R project and use the **here** package.

<!-- ======================================================= -->

### Providing file paths {.unnumbered}

Perhaps the most common source of frustration for an R beginner (at least on a Windows machine) is typing in a file path to import or export data. There is a thorough explanation of how to best input file paths in the \[Import and export\] page, but here are a few key points:

**Broken paths**

Below is an example of an "absolute" or "full address" file path. These will likely break if used by another computer. One exception is if you are using a shared/network drive.

    C:/Users/Name/Document/Analytic Software/R/Projects/Analysis2019/data/March2019.csv  

**Slash direction**

*If typing in a file path, be aware the direction of the slashes.* Use *forward slashes* (`/`) to separate the components ("data/provincial.csv"). For Windows users, the default way that file paths are displayed is with *back slashes* (\\) - so you will need to change the direction of each slash. If you use the **here** package as described in the \[R projects\] page the slash direction is not an issue.

**Relative file paths**

We generally recommend providing "relative" filepaths instead - that is, the path *relative to* the root of your R Project. You can do this using the **here** package as explained in the \[R projects\] page. A relativel filepath might look like this:

```{r, eval=F}
# Import csv linelist from the data/linelist/clean/ sub-folders of an R project
linelist <- import(here("data", "clean", "linelists", "marin_country.csv"))
```

Even if using relative file paths within an R project, you can still use absolute paths to import/export data outside your R project.

<!-- ======================================================= -->

## Objects {#objects}

Everything in R is an object, and R is an "object-oriented" language. These sections will explain:

-   How to create objects (`<-`)
-   Types of objects (e.g. data frames, vectors..)\
-   How to access subparts of objects (e.g. variables in a dataset)\
-   Classes of objects (e.g. numeric, logical, integer, double, character, factor)

<!-- ======================================================= -->

### Everything is an object {.unnumbered}

*This section is adapted from the [R4Epis project](https://r4epis.netlify.app/training/r_basics/objects/).*\
Everything you store in R - datasets, variables, a list of village names, a total population number, even outputs such as graphs - are **objects** which are **assigned a name** and **can be referenced** in later commands.

An object exists when you have assigned it a value (see the assignment section below). When it is assigned a value, the object appears in the Environment (see the upper right pane of RStudio). It can then be operated upon, manipulated, changed, and re-defined.

<!-- ======================================================= -->

### Defining objects (`<-`) {.unnumbered}

**Create objects *by assigning them a value* with the \<- operator.**\
You can think of the assignment operator `<-` as the words "is defined as". Assignment commands generally follow a standard order:

**object_name** \<- **value** (or process/calculation that produce a value)

For example, you may want to record the current epidemiological reporting week as an object for reference in later code. In this example, the object `current_week` is created when it is assigned the value `"2018-W10"` (the quote marks make this a character value). The object `current_week` will then appear in the RStudio Environment pane (upper-right) and can be referenced in later commands.

See the R commands and their output in the boxes below.

```{r basics_objects_assignment}
current_week <- "2018-W10"   # this command creates the object current_week by assigning it a value
current_week                 # this command prints the current value of current_week object in the console
```

[***NOTE:*** Note the `[1]` in the R console output is simply indicating that you are viewing the first item of the output]{style="color: black;"}

[***CAUTION:*** **An object's value can be over-written** at any time by running an assignment command to re-define its value. Thus, the **order of the commands run is very important**.]{style="color: orange;"}

The following command will re-define the value of `current_week`:

```{r basics_objects_reassignment}
current_week <- "2018-W51"   # assigns a NEW value to the object current_week
current_week                 # prints the current value of current_week in the console
```

**Equals signs `=`**

You will also see equals signs in R code:

-   A double equals sign `==` between two objects or values asks a logical *question*: "is this equal to that?".\
-   You will also see equals signs within functions used to specify values of function arguments (read about these in sections below), for example `max(age, na.rm = TRUE)`.\
-   You *can* use a single equals sign `=` in place of `<-` to create and define objects, but this is discouraged. You can read about why this is discouraged [here](https://renkun.me/2014/01/28/difference-between-assignment-operators-in-r/).

**Datasets**

Datasets are also objects (typically "dataframes") and must be assigned names when they are imported. In the code below, the object `linelist` is created and assigned the value of a CSV file imported with the **rio** package and its `import()` function.

```{r basics_objects_dataframes, eval=FALSE}
# linelist is created and assigned the value of the imported CSV file
linelist <- import("my_linelist.csv")
```

You can read more about importing and exporting datasets with the section on \[Import and export\].

[***CAUTION:*** A quick note on naming of objects:]{style="color: orange;"}

-   Object names must not contain spaces, but you should use underscore (\_) or a period (.) instead of a space.\
-   Object names are case-sensitive (meaning that Dataset_A is different from dataset_A).
-   Object names must begin with a letter (cannot begin with a number like 1, 2 or 3).

**Outputs**

Outputs like tables and plots provide an example of how outputs can be saved as objects, or just be printed without being saved. A cross-tabulation of gender and outcome using the **base** R function `table()` can be printed directly to the R console (*without* being saved).

```{r}
# printed to R console only
table(linelist$gender, linelist$outcome)
```

But the same table can be saved as a named object. Then, optionally, it can be printed.

```{r}
# save
gen_out_table <- table(linelist$gender, linelist$outcome)

# print
gen_out_table
```

**Columns**

Columns in a dataset are also objects and can be defined, over-written, and created as described below in the section on Columns.

You can use the assignment operator from **base** R to create a new column. Below, the new column `bmi` (Body Mass Index) is created, and for each row the new value is result of a mathematical operation on the row's value in the `wt_kg` and `ht_cm` columns.

```{r, eval=F}
# create new "bmi" column using base R syntax
linelist$bmi <- linelist$wt_kg / (linelist$ht_cm/100)^2
```

However, in this handbook, we emphasize a different approach to defining columns, which uses the function `mutate()` from the **dplyr** package and *piping* with the pipe operator (`%>%`). The syntax is easier to read and there are other advantages explained in the page on \[Cleaning data and core functions\]. You can read more about *piping* in the Piping section below.

```{r, eval=F}
# create new "bmi" column using dplyr syntax
linelist <- linelist %>% 
  mutate(bmi = wt_kg / (ht_cm/100)^2)
```

<!-- ======================================================= -->

### Object structure {.unnumbered}

**Objects can be a single piece of data (e.g. `my_number <- 24`), or they can consist of structured data.**

The graphic below is borrowed from [this online R tutorial](http://venus.ifca.unican.es/Rintro/dataStruct.html). It shows some common data structures and their names. Not included in this image is spatial data, which is discussed in the \[GIS basics\] page.

```{r basics_objects_structures, echo=F, out.width = "75%", out.height="50%", fig.align = "center"}
knitr::include_graphics(here::here("images", "R_data_structures.png"))
```

In epidemiology (and particularly field epidemiology), you will *most commonly* encounter data frames and vectors:

+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Common structure | Explanation                                                                                      | Example                                                                             |
+==================+==================================================================================================+=====================================================================================+
| Vectors          | A container for a sequence of singular objects, all of the same class (e.g. numeric, character). | **"Variables" (columns) in data frames are vectors** (e.g. the column `age_years`). |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| Data Frames      | Vectors (e.g. columns) that are bound together that all have the same number of rows.            | `linelist` is a data frame.                                                         |
+------------------+--------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+

Note that to create a vector that "stands alone" (is not part of a data frame) the function `c()` is used to combine the different elements. For example, if creating a vector of colors plot's color scale: `vector_of_colors <- c("blue", "red2", "orange", "grey")`

<!-- ======================================================= -->

### Object classes {.unnumbered}

All the objects stored in R have a *class* which tells R how to handle the object. There are many possible classes, but common ones include:

+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Class      | Explanation                                                                                                                                                                             | Examples                                                                                              |
+============+=========================================================================================================================================================================================+=======================================================================================================+
| Character  | These are text/words/sentences **"within quotation marks"**. Math cannot be done on these objects.                                                                                      | "Character objects are in quotation marks"                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Integer    | Numbers that are **whole only** (no decimals)                                                                                                                                           | -5, 14, or 2000                                                                                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Numeric    | These are numbers and **can include decimals**. If within quotation marks they will be considered character class.                                                                      | 23.1 or 14                                                                                            |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Factor     | These are vectors that have a **specified order** or hierarchy of values                                                                                                                | An variable of economic status with ordered values                                                    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Date       | **Once R is told that certain data are Dates**, these data can be manipulated and displayed in special ways. See the page on \[Working with dates\] for more information.               | 2018-04-12 or 15/3/1954 or Wed 4 Jan 1980                                                             |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| Logical    | Values must be one of the two special values TRUE or FALSE (note these are **not** "TRUE" and "FALSE" in quotation marks)                                                               | TRUE or FALSE                                                                                         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| data.frame | A data frame is how R stores a **typical dataset**. It consists of vectors (columns) of data bound together, that all have the same number of observations (rows).                      | The example AJS dataset named `linelist_raw` contains 68 variables with 300 observations (rows) each. |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| tibble     | tibbles are a variation on data frame, the main operational difference being that they print more nicely to the console (display first 10 rows and only columns that fit on the screen) | Any data frame, list, or matrix can be converted to a tibble with `as_tibble()`                       |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
| list       | A list is like vector, but holds other objects that can be other different classes                                                                                                      | A list could hold a single number, and a dataframe, and a vector, and even another list within it!    |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+

**You can test the class of an object by providing its name to the function `class()`**. Note: you can reference a specific column within a dataset using the `$` notation to separate the name of the dataset and the name of the column.

```{r, echo=TRUE,}
class(linelist)         # class should be a data frame or tibble

class(linelist$age)     # class should be numeric

class(linelist$gender)  # class should be character
```

Sometimes, a column will be converted to a different class automatically by R. Watch out for this! For example, if you have a vector or column of numbers, but a character value is inserted... the entire column will change to class character.

```{r}
num_vector <- c(1,2,3,4,5) # define vector as all numbers
class(num_vector)          # vector is numeric class
num_vector[3] <- "three"   # convert the third element to a character
class(num_vector)          # vector is now character class
```

One common example of this is when manipulating a data frame in order to print a table - if you make a total row and try to paste/glue together percents in the same cell as numbers (e.g. `23 (40%)`), the entire numeric column above will convert to character and can no longer be used for mathematical calculations.**Sometimes, you will need to convert objects or columns to another class.**

+------------------+---------------------------------------------------------------------------------------+
| Function         | Action                                                                                |
+==================+=======================================================================================+
| `as.character()` | Converts to character class                                                           |
+------------------+---------------------------------------------------------------------------------------+
| `as.numeric()`   | Converts to numeric class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.integer()`   | Converts to integer class                                                             |
+------------------+---------------------------------------------------------------------------------------+
| `as.Date()`      | Converts to Date class - Note: see section on [dates](#dates) for details             |
+------------------+---------------------------------------------------------------------------------------+
| `factor()`       | Converts to factor - Note: re-defining order of value levels requires extra arguments |
+------------------+---------------------------------------------------------------------------------------+

Likewise, there are **base** R functions to check whether an object IS of a specific class, such as `is.numeric()`, `is.character()`, `is.double()`, `is.factor()`, `is.integer()`

Here is [more online material on classes and data structures in R](https://swcarpentry.github.io/r-novice-inflammation/13-supp-data-structures/).

<!-- ======================================================= -->

### Columns/Variables (`$`) {.unnumbered}

**A column in a data frame is technically a "vector" (see table above)** - a series of values that must all be the same class (either character, numeric, logical, etc).

A vector can exist independent of a data frame, for example a vector of column names that you want to include as explanatory variables in a model. To create a "stand alone" vector, use the `c()` function as below:

```{r, warning=F, message=F}
# define the stand-alone vector of character values
explanatory_vars <- c("gender", "fever", "chills", "cough", "aches", "vomit")

# print the values in this named vector
explanatory_vars
```

**Columns in a data frame are also vectors and can be called, referenced, extracted, or created using the `$` symbol.** The `$` symbol connects the name of the column to the name of its data frame. In this handbook, we try to use the word "column" instead of "variable".

```{r basics_objects_call, eval=F}
# Retrieve the length of the vector age_years
length(linelist$age) # (age is a column in the linelist data frame)

```

By typing the name of the dataframe followed by `$` you will also see a drop-down menu of all columns in the data frame. You can scroll through them using your arrow key, select one with your Enter key, and avoid spelling mistakes!

```{r echo=F, out.width = "100%", fig.align = "center"}
knitr::include_graphics(here::here("images", "Calling_Names.gif"))
```

[***ADVANCED TIP:*** Some more complex objects (e.g. a list, or an `epicontacts` object) may have multiple levels which can be accessed through multiple dollar signs. For example `epicontacts$linelist$date_onset`]{style="color: darkgreen;"}

<!-- ======================================================= -->

### Access/index with brackets (`[ ]`) {.unnumbered}

You may need to view parts of objects, also called "indexing", which is often done using the square brackets `[ ]`. Using `$` on a dataframe to access a column is also a type of indexing.

```{r}
my_vector <- c("a", "b", "c", "d", "e", "f")  # define the vector
my_vector[5]                                  # print the 5th element
```

Square brackets also work to return specific parts of an returned output, such as the output of a `summary()` function:

```{r}
# All of the summary
summary(linelist$age)

# Just the second element of the summary, with name (using only single brackets)
summary(linelist$age)[2]

# Just the second element, without name (using double brackets)
summary(linelist$age)[[2]]

# Extract an element by name, without showing the name
summary(linelist$age)[["Median"]]

```

Brackets also work on data frames to view specific rows and columns. You can do this using the syntax `dataframe[rows, columns]`:

```{r basics_objects_access, eval=F}
# View a specific row (2) from dataset, with all columns (don't forget the comma!)
linelist[2,]

# View all rows, but just one column
linelist[, "date_onset"]

# View values from row 2 and columns 5 through 10
linelist[2, 5:10] 

# View values from row 2 and columns 5 through 10 and 18
linelist[2, c(5:10, 18)] 

# View rows 2 through 20, and specific columns
linelist[2:20, c("date_onset", "outcome", "age")]

# View rows and columns based on criteria
# *** Note the dataframe must still be named in the criteria!
linelist[linelist$age > 25 , c("date_onset", "outcome", "age")]

# Use View() to see the outputs in the RStudio Viewer pane (easier to read) 
# *** Note the capital "V" in View() function
View(linelist[2:20, "date_onset"])

# Save as a new object
new_table <- linelist[2:20, c("date_onset")] 
```

Note that you can also achieve the above row/column indexing on data frames and tibbles using **dplyr** syntax (functions `filter()` for rows, and `select()` for columns). Read more about these core functions in the \[Cleaning data and core functions\] page.

To filter based on "row number", you can use the **dplyr** function `row_number()` with open parentheses as part of a logical filtering statement. Often you will use the `%in%` operator and a range of numbers as part of that logical statement, as shown below. To see the *first* N rows, you can also use the special **dplyr** function `head()`.

```{r, eval=F}
# View first 100 rows
linelist %>% head(100)

# Show row 5 only
linelist %>% filter(row_number() == 5)

# View rows 2 through 20, and three specific columns (note no quotes necessary on column names)
linelist %>% filter(row_number() %in% 2:20) %>% select(date_onset, outcome, age)
```

When indexing an object of class **list**, single brackets always return with class list, even if only a single object is returned. Double brackets, however, can be used to access a single element and return a different class than list.\
Brackets can also be written after one another, as demonstrated below.

This [visual explanation of lists indexing, with pepper shakers](https://r4ds.had.co.nz/vectors.html#lists-of-condiments) is humorous and helpful.

```{r}
# define demo list
my_list <- list(
  # First element in the list is a character vector
  hospitals = c("Central", "Empire", "Santa Anna"),
  
  # second element in the list is a data frame of addresses
  addresses   = data.frame(
    street = c("145 Medical Way", "1048 Brown Ave", "999 El Camino"),
    city   = c("Andover", "Hamilton", "El Paso")
    )
  )
```

Here is how the list looks when printed to the console. See how there are two named elements:

-   `hospitals`, a character vector\
-   `addresses`, a data frame of addresses

```{r}
my_list
```

Now we extract, using various methods:

```{r}
my_list[1] # this returns the element in class "list" - the element name is still displayed

my_list[[1]] # this returns only the (unnamed) character vector

my_list[["hospitals"]] # you can also index by name of the list element

my_list[[1]][3] # this returns the third element of the "hospitals" character vector

my_list[[2]][1] # This returns the first column ("street") of the address data frame

```

<!-- ======================================================= -->

### Remove objects {.unnumbered}

You can remove individual objects from your R environment by putting the name in the `rm()` function (no quote marks):

```{r, eval=F}
rm(object_name)
```

You can remove all objects (clear your workspace) by running:

```{r, eval=F}
rm(list = ls(all = TRUE))
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Piping (`%>%`)

**Two general approaches to working with objects are:**

1)  **Pipes/tidyverse** - pipes send an object from function to function - emphasis is on the *action*, not the object\
2)  **Define intermediate objects** - an object is re-defined again and again - emphasis is on the object

<!-- ======================================================= -->

### **Pipes** {.unnumbered}

**Simply explained, the pipe operator (`%>%`) passes an intermediate output from one function to the next.**\
You can think of it as saying "then". Many functions can be linked together with `%>%`.

-   **Piping emphasizes a sequence of actions, not the object the actions are being performed on**\
-   Pipes are best when a sequence of actions must be performed on one object\
-   Pipes come from the package **magrittr**, which is automatically included in packages **dplyr** and **tidyverse**
-   Pipes can make code more clean and easier to read, more intuitive

Read more on this approach in the tidyverse [style guide](https://style.tidyverse.org/pipes.html)

Here is a fake example for comparison, using fictional functions to "bake a cake". First, the pipe method:

```{r piping_example_pipe, eval=F}
# A fake example of how to bake a cake using piping syntax

cake <- flour %>%       # to define cake, start with flour, and then...
  add(eggs) %>%   # add eggs
  add(oil) %>%    # add oil
  add(water) %>%  # add water
  mix_together(         # mix together
    utensil = spoon,
    minutes = 2) %>%    
  bake(degrees = 350,   # bake
       system = "fahrenheit",
       minutes = 35) %>%  
  let_cool()            # let it cool down
```

Here is another [link](https://cfss.uchicago.edu/notes/pipes/#:~:text=Pipes%20are%20an%20extremely%20useful,code%20and%20combine%20multiple%20operations) describing the utility of pipes.

Piping is not a **base** function. To use piping, the **magrittr** package must be installed and loaded (this is typically done by loading **tidyverse** or **dplyr** package which include it). You can [read more about piping in the magrittr documentation](https://magrittr.tidyverse.org/).

Note that just like other R commands, pipes can be used to just display the result, or to save/re-save an object, depending on whether the assignment operator `<-` is involved. See both below:

```{r, eval=F}
# Create or overwrite object, defining as aggregate counts by age category (not printed)
linelist_summary <- linelist %>% 
  count(age_cat)
```

```{r}
# Print the table of counts in the console, but don't save it
linelist %>% 
  count(age_cat)
```

**`%<>%`**\
This is an "assignment pipe" from the **magrittr** package, which *pipes an object forward and also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand. The below two commands are equivalent:

```{r, eval=F}
linelist <- linelist %>%
  filter(age > 50)

linelist %<>% filter(age > 50)
```

<!-- ======================================================= -->

### Define intermediate objects {.unnumbered}

This approach to changing objects/dataframes may be better if:

-   You need to manipulate multiple objects\
-   There are intermediate steps that are meaningful and deserve separate object names

**Risks:**

-   Creating new objects for each step means creating lots of objects. If you use the wrong one you might not realize it!\
-   Naming all the objects can be confusing\
-   Errors may not be easily detectable

Either name each intermediate object, or overwrite the original, or combine all the functions together. All come with their own risks.

Below is the same fake "cake" example as above, but using this style:

```{r piping_example_redefine, eval=F}
# a fake example of how to bake a cake using this method (defining intermediate objects)
batter_1 <- left_join(flour, eggs)
batter_2 <- left_join(batter_1, oil)
batter_3 <- left_join(batter_2, water)

batter_4 <- mix_together(object = batter_3, utensil = spoon, minutes = 2)

cake <- bake(batter_4, degrees = 350, system = "fahrenheit", minutes = 35)

cake <- let_cool(cake)
```

Combine all functions together - this is difficult to read:

```{r eval=F}
# an example of combining/nesting mutliple functions together - difficult to read
cake <- let_cool(bake(mix_together(batter_3, utensil = spoon, minutes = 2), degrees = 350, system = "fahrenheit", minutes = 35))
```

<!-- ======================================================= -->

## Key operators and functions {#operators}

This section details operators in R, such as:

-   Definitional operators\
-   Relational operators (less than, equal too..)\
-   Logical operators (and, or...)\
-   Handling missing values\
-   Mathematical operators and functions (+/-, >, sum(), median(), ...)\
-   The `%in%` operator

<!-- ======================================================= -->

### Assignment operators {.unnumbered}

**`<-`**

The basic assignment operator in R is `<-`. Such that `object_name <- value`.\
This assignment operator can also be written as `=`. We advise use of `<-` for general R use.\
We also advise surrounding such operators with spaces, for readability.

**`<<-`**

If [Writing functions], or using R in an interactive way with sourced scripts, then you may need to use this assignment operator `<<-` (from **base** R). This operator is used to define an object in a higher 'parent' R Environment. See this [online reference](https://stat.ethz.ch/R-manual/R-devel/library/base/html/assignOps.html).

**`%<>%`**

This is an "assignment pipe" from the **magrittr** package, which pipes an object forward and *also re-defines the object*. It must be the first pipe operator in the chain. It is shorthand, as shown below in two equivalent examples:

```{r, eval=F}
linelist <- linelist %>% 
  mutate(age_months = age_years * 12)
```

The above is equivalent to the below:

```{r, eval=F}
linelist %<>% mutate(age_months = age_years * 12)
```

**`%<+%`**

This is used to add data to phylogenetic trees with the **ggtree** package. See the page on \[Phylogenetic trees\] or this online [resource book](https://yulab-smu.top/treedata-book/).

<!-- ======================================================= -->

### Relational and logical operators {.unnumbered}

Relational operators compare values and are often used when defining new variables and subsets of datasets. Here are the common relational operators in R:

+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Meaning                  | Operator     | Example      | Example Result                                                                                                                                         |
+==========================+==============+==============+========================================================================================================================================================+
| Equal to                 | `==`         | `"A" == "a"` | `FALSE` (because R is case sensitive) *Note that == (double equals) is different from = (single equals), which acts like the assignment operator `<-`* |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Not equal to             | `!=`         | `2 != 0`     | `TRUE`                                                                                                                                                 |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than             | `>`          | `4 > 2`      | `TRUE`                                                                                                                                                 |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than                | `<`          | `4 < 2`      | `FALSE`                                                                                                                                                |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Greater than or equal to | `>=`         | `6 >= 4`     | `TRUE`                                                                                                                                                 |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Less than or equal to    | `<=`         | `6 <= 4`     | `FALSE`                                                                                                                                                |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is missing         | `is.na()`    | `is.na(7)`   | `FALSE` (see page on \[Missing data\])                                                                                                                 |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+
| Value is not missing     | `!is.na()`   | `!is.na(7)`  | `TRUE`                                                                                                                                                 |
+--------------------------+--------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+

Logical operators, such as AND and OR, are often used to connect relational operators and create more complicated criteria. Complex statements might require parentheses ( ) for grouping and order of application.

+---------------------+-----------------------------------------------------------------------+
| Meaning             | Operator                                                              |
+=====================+=======================================================================+
| AND                 | `&`                                                                   |
+---------------------+-----------------------------------------------------------------------+
| OR                  | `|` (vertical bar)                                                    |
+---------------------+-----------------------------------------------------------------------+
| Parentheses         | `( )` Used to group criteria together and clarify order of operations |
+---------------------+-----------------------------------------------------------------------+

For example, below, we have a linelist with two variables we want to use to create our case definition, `hep_e_rdt`, a test result and `other_cases_in_hh`, which will tell us if there are other cases in the household. The command below uses the function `case_when()` to create the new variable `case_def` such that:

```{r eval=FALSE}
linelist_cleaned <- linelist %>%
  mutate(case_def = case_when(
    is.na(rdt_result) & is.na(other_case_in_home)            ~ NA_character_,
    rdt_result == "Positive"                                 ~ "Confirmed",
    rdt_result != "Positive" & other_cases_in_home == "Yes"  ~ "Probable",
    TRUE                                                     ~ "Suspected"
  ))
```

+------------------------------------------------------------------------------------------------+--------------------------------------------+
| Criteria in example above                                                                      | Resulting value in new variable "case_def" |
+================================================================================================+============================================+
| If the value for variables `rdt_result` and `other_cases_in_home` are missing                  | `NA` (missing)                             |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is "Positive"                                                     | "Confirmed"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If the value in `rdt_result` is NOT "Positive" AND the value in `other_cases_in_home` is "Yes" | "Probable"                                 |
+------------------------------------------------------------------------------------------------+--------------------------------------------+
| If one of the above criteria are not met                                                       | "Suspected"                                |
+------------------------------------------------------------------------------------------------+--------------------------------------------+

*Note that R is case-sensitive, so "Positive" is different than "positive"...*

<!-- ======================================================= -->

### Missing values {.unnumbered}

In R, missing values are represented by the special value `NA` (a "reserved" value) (capital letters N and A - not in quotation marks). If you import data that records missing data in another way (e.g. 99, "Missing", or .), you may want to re-code those values to `NA`. How to do this is addressed in the \[Import and export\] page.

**To test whether a value is `NA`, use the special function `is.na()`**, which returns `TRUE` or `FALSE`.

```{r basics_operators_missing}
rdt_result <- c("Positive", "Suspected", "Positive", NA)   # two positive cases, one suspected, and one unknown
is.na(rdt_result)  # Tests whether the value of rdt_result is NA
```

Read more about missing, infinite, `NULL`, and impossible values in the page on \[Missing data\]. Learn how to convert missing values when importing data in the page on \[Import and export\].

<!-- ======================================================= -->

### Mathematics and statistics {.unnumbered}

All the operators and functions in this page are automatically available using **base** R.

#### Mathematical operators {.unnumbered}

These are often used to perform addition, division, to create new columns, etc. Below are common mathematical operators in R. Whether you put spaces around the operators is not important.

| Purpose             | Example in R |
|---------------------|--------------|
| addition            | 2 + 3        |
| subtraction         | 2 - 3        |
| multiplication      | 2 \* 3       |
| division            | 30 / 5       |
| exponent            | 2\^3         |
| order of operations | ( )          |

#### Mathematical functions {.unnumbered}

| Purpose            | Function                              |
|--------------------|---------------------------------------|
| rounding           | round(x, digits = n)                  |
| rounding           | janitor::round_half_up(x, digits = n) |
| ceiling (round up) | ceiling(x)                            |
| floor (round down) | floor(x)                              |
| absolute value     | abs(x)                                |
| square root        | sqrt(x)                               |
| exponent           | exponent(x)                           |
| natural logarithm  | log(x)                                |
| log base 10        | log10(x)                              |
| log base 2         | log2(x)                               |

Note: for `round()` the `digits =` specifies the number of decimal placed. Use `signif()` to round to a number of significant figures.

#### Scientific notation {.unnumbered}

The likelihood of scientific notation being used depends on the value of the `scipen` option.

From the documentation of `?options`: scipen is a penalty to be applied when deciding to print numeric values in fixed or exponential notation. Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than 'scipen' digits wider.

If it is set to a low number (e.g. 0) it will be "turned on" always. To "turn off" scientific notation in your R session, set it to a very high number, for example:

```{r, eval=F}
# turn off scientific notation
options(scipen=999)
```

#### Rounding {.unnumbered}

[***DANGER:*** `round()` uses "banker's rounding" which rounds up from a .5 only if the upper number is even. Use `round_half_up()` from **janitor** to consistently round halves up to the nearest whole number. See [this explanation](https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html#explore-records-with-duplicated-values-for-specific-combinations-of-variables-with-get_dupes) ]{style="color: red;"}

```{r}
# use the appropriate rounding function for your work
round(c(2.5, 3.5))

janitor::round_half_up(c(2.5, 3.5))
```

#### Statistical functions {.unnumbered}

[***CAUTION:*** The functions below will by default include missing values in calculations. Missing values will result in an output of `NA`, unless the argument `na.rm = TRUE` is specified. This can be written shorthand as `na.rm = T`.]{style="color: orange;"}

| Objective               | Function           |
|-------------------------|--------------------|
| mean (average)          | mean(x, na.rm=T)   |
| median                  | median(x, na.rm=T) |
| standard deviation      | sd(x, na.rm=T)     |
| quantiles\*             | quantile(x, probs) |
| sum                     | sum(x, na.rm=T)    |
| minimum value           | min(x, na.rm=T)    |
| maximum value           | max(x, na.rm=T)    |
| range of numeric values | range(x, na.rm=T)  |
| summary\*\*             | summary(x)         |

Notes:

-   `*quantile()`: `x` is the numeric vector to examine, and `probs =` is a numeric vector with probabilities within 0 and 1.0, e.g `c(0.5, 0.8, 0.85)`
-   `**summary()`: gives a summary on a numeric vector including mean, median, and common percentiles

[***DANGER:*** If providing a vector of numbers to one of the above functions, be sure to wrap the numbers within `c()` .]{style="color: red;"}

```{r}
# If supplying raw numbers to a function, wrap them in c()
mean(1, 6, 12, 10, 5, 0)    # !!! INCORRECT !!!  

mean(c(1, 6, 12, 10, 5, 0)) # CORRECT
```

#### Other useful functions {.unnumbered}

+----------------------------+-------------------+-------------------------------------------------+
| Objective                  | Function          | Example                                         |
+============================+===================+=================================================+
| create a sequence          | seq(from, to, by) | `seq(1, 10, 2)`                                 |
+----------------------------+-------------------+-------------------------------------------------+
| repeat x, n times          | rep(x, ntimes)    | `rep(1:3, 2)` or `rep(c("a", "b", "c"), 3)`     |
+----------------------------+-------------------+-------------------------------------------------+
| subdivide a numeric vector | cut(x, n)         | `cut(linelist$age, 5)`                          |
+----------------------------+-------------------+-------------------------------------------------+
| take a random sample       | sample(x, size)   | `sample(linelist$id, size = 5, replace = TRUE)` |
+----------------------------+-------------------+-------------------------------------------------+

<!-- ======================================================= -->

### `%in%` {.unnumbered}

A very useful operator for matching values, and for quickly assessing if a value is within a vector or dataframe.

```{r}
my_vector <- c("a", "b", "c", "d")
```

```{r}
"a" %in% my_vector
"h" %in% my_vector
```

To ask if a value is **not** `%in%` a vector, put an exclamation mark (!) **in front** of the logic statement:

```{r}
# to negate, put an exclamation in front
!"a" %in% my_vector
!"h" %in% my_vector
```

`%in%` is very useful when using the **dplyr** function `case_when()`. You can define a vector previously, and then reference it later. For example:

```{r eval=F}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")

linelist <- linelist %>% 
  mutate(child_hospitaled = case_when(
    hospitalized %in% affirmative & age < 18 ~ "Hospitalized Child",
    TRUE                                      ~ "Not"))
```

Note: If you want to detect a partial string, perhaps using `str_detect()` from **stringr**, it will not accept a character vector like `c("1", "Yes", "yes", "y")`. Instead, it must be given a *regular expression* - one condensed string with OR bars, such as "1\|Yes\|yes\|y". For example, `str_detect(hospitalized, "1|Yes|yes|y")`. See the page on \[Characters and strings\] for more information.

You can convert a character vector to a named regular expression with this command:

```{r}
affirmative <- c("1", "Yes", "YES", "yes", "y", "Y", "oui", "Oui", "Si")
affirmative

# condense to 
affirmative_str_search <- paste0(affirmative, collapse = "|")  # option with base R
affirmative_str_search <- str_c(affirmative, collapse = "|")   # option with stringr package

affirmative_str_search
```

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

## Errors & warnings

This section explains:

-   The difference between errors and warnings\
-   General syntax tips for writing R code\
-   Code assists

Common errors and warnings and troubleshooting tips can be found in the page on \[Errors and help\].

<!-- ======================================================= -->

### Error versus Warning {.unnumbered}

When a command is run, the R Console may show you warning or error messages in red text.

-   A **warning** means that R has completed your command, but had to take additional steps or produced unusual output that you should be aware of.

-   An **error** means that R was not able to complete your command.

Look for clues:

-   The error/warning message will often include a line number for the problem.

-   If an object "is unknown" or "not found", perhaps you spelled it incorrectly, forgot to call a package with library(), or forgot to re-run your script after making changes.

If all else fails, copy the error message into Google along with some key terms - chances are that someone else has worked through this already!

<!-- ======================================================= -->

### General syntax tips {.unnumbered}

A few things to remember when writing commands in R, to avoid errors and warnings:

-   Always close parentheses - tip: count the number of opening "(" and closing parentheses ")" for each code chunk
-   Avoid spaces in column and object names. Use underscore ( \_ ) or periods ( . ) instead
-   Keep track of and remember to separate a function's arguments with commas
-   R is case-sensitive, meaning `Variable_A` is *different* from `variable_A`

<!-- ======================================================= -->

### Code assists {.unnumbered}

Any script (RMarkdown or otherwise) will give clues when you have made a mistake. For example, if you forgot to write a comma where it is needed, or to close a parentheses, RStudio will raise a flag on that line, on the right side of the script, to warn you.
